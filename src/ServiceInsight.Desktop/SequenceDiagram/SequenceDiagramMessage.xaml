<UserControl x:Class="Particular.ServiceInsight.Desktop.SequenceDiagram.SequenceDiagramMessage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:sequenceDiagram="clr-namespace:Particular.ServiceInsight.Desktop.SequenceDiagram"
             d:DataContext="{d:DesignData /SampleData/MessageInfoSampleData.xaml}"
             d:DesignHeight="600"
             d:DesignWidth="900"
             mc:Ignorable="d">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="SequenceDiagramSharedResources.xaml" />

                <ResourceDictionary>

                    <sequenceDiagram:EndpointPositionConverter x:Key="MiddleEndpointConverter"
                                                               ColumnWidth="{StaticResource ColumnWidth}"
                                                               Middle="True" />

                    <sequenceDiagram:EndpointThicknessConverter x:Key="ToEndpointMarginConverter" ColumnWidth="{StaticResource ColumnWidth}" />

                    <sequenceDiagram:EndpointThicknessConverter x:Key="MessageEndpointMarginConverter"
                                                                ColumnWidth="{StaticResource ColumnWidth}"
                                                                Middle="True"
                                                                Top="-36" />

                    <sequenceDiagram:EndpointThicknessConverter x:Key="StartMessageMarginConverter"
                                                                ColumnWidth="{StaticResource ColumnWidth}"
                                                                Top="-36" />
                </ResourceDictionary>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid>
        <!--  Padding for endpoints  -->
        <ItemsControl x:Name="EndpointPaddings"
                      ItemsSource="{Binding Endpoints}"
                      Style="{StaticResource HorizontalItemsControlStyle}">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border Width="{StaticResource ColumnWidth}" />
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!--  Horizontal line  -->
        <Line x:Name="HorizontalLine"
              Fill="Black"
              Stroke="Black"
              StrokeEndLineCap="Square"
              StrokeThickness="4"
              X1="{Binding FromEndpointIndex,
                           Converter={StaticResource MiddleEndpointConverter}}"
              X2="{Binding LastToEndpointIndex,
                           Converter={StaticResource MiddleEndpointConverter}}"
              Y1="0"
              Y2="0" />

        <!--  Start message arrow  -->
        <Grid x:Name="StartMessageArrow"
              Width="{StaticResource ColumnWidth}"
              Height="72"
              Margin="{Binding FromEndpointIndex,
                               Converter={StaticResource StartMessageMarginConverter}}"
              HorizontalAlignment="Left"
              VerticalAlignment="Top"
              Visibility="{Binding IsStartMessage,
                                   Converter={StaticResource BoolToVisibilityConverter}}">
            <Rectangle Width="25"
                       Height="25"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Fill="Black" />
            <Path Width="10"
                  Height="10"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Data="{StaticResource RightArrow}"
                  Fill="White"
                  Stretch="Fill" />
        </Grid>

        <!--  Message Popup  -->
        <Border x:Name="MessagePopup"
                Width="{StaticResource ColumnWidth}"
                Height="72"
                Margin="{Binding MessagePopupIndex,
                                 Converter={StaticResource MessageEndpointMarginConverter}}"
                HorizontalAlignment="Left"
                VerticalAlignment="Top">

            <Grid x:Name="PopupBorder"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <Border Height="29"
                        VerticalAlignment="Top"
                        Background="{Binding (sequenceDiagram:Palette.Brush3),
                                             ElementName=PopupBorder}" />
                <Border Height="27"
                        VerticalAlignment="Bottom"
                        Background="{Binding (sequenceDiagram:Palette.Brush3),
                                             ElementName=PopupBorder}"
                        Visibility="{Binding SagaName,
                                             Converter={StaticResource StringEmptyOrNullToVisibilityConverter}}" />

                <Grid Margin="5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="22" />
                        <RowDefinition Height="22" />
                    </Grid.RowDefinitions>

                    <!--  Top Line  -->
                    <StackPanel x:Name="TopLine"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Orientation="Horizontal">
                        <Path Width="16"
                              Height="16"
                              Margin="2 0"
                              Data="{StaticResource StartMessageGeometry}"
                              Fill="{Binding (sequenceDiagram:Palette.Brush1),
                                             ElementName=PopupBorder}"
                              Stretch="Fill"
                              Visibility="{Binding IsStartMessage,
                                                   Converter={StaticResource BoolToVisibilityConverter}}" />

                        <Path Width="16"
                              Height="16"
                              Margin="2 0"
                              Data="{StaticResource MessageGeometry}"
                              Fill="{Binding (sequenceDiagram:Palette.Brush1),
                                             ElementName=PopupBorder}"
                              Stretch="Fill"
                              Visibility="{Binding IsStartMessage,
                                                   Converter={StaticResource BoolToVisibilityConverterInverted}}" />

                        <Label Padding="5 0"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Content="{Binding Name}"
                               Foreground="{Binding (sequenceDiagram:Palette.Brush1),
                                                    ElementName=PopupBorder}" />

                        <Path Width="4"
                              Height="4"
                              Margin="2,0,2,3"
                              VerticalAlignment="Bottom"
                              Data="{StaticResource DownArrow}"
                              Fill="{Binding (sequenceDiagram:Palette.Brush1),
                                             ElementName=PopupBorder}"
                              Stretch="Fill" />
                    </StackPanel>

                    <!--  Bottom Line  -->
                    <StackPanel x:Name="BottomLine"
                                Grid.Row="1"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Bottom"
                                Orientation="Horizontal"
                                Visibility="{Binding SagaName,
                                                     Converter={StaticResource StringEmptyOrNullToVisibilityConverter}}">
                        <Grid Margin="0,0,1,0">
                            <Rectangle Width="18"
                                       Height="18"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Fill="{Binding (sequenceDiagram:Palette.Brush1),
                                                      ElementName=PopupBorder}" />
                            <Path Width="9"
                                  Height="9"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  Data="{StaticResource RightArrow}"
                                  Fill="{Binding (sequenceDiagram:Palette.Brush2),
                                                 ElementName=PopupBorder}"
                                  Stretch="Fill"
                                  Visibility="{Binding IsStartMessage,
                                                       Converter={StaticResource BoolToVisibilityConverter}}" />
                            <Path Width="9"
                                  Height="9"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  Data="{StaticResource SagaGeometry}"
                                  Fill="{Binding (sequenceDiagram:Palette.Brush2),
                                                 ElementName=PopupBorder}"
                                  Stretch="Fill"
                                  Visibility="{Binding IsStartMessage,
                                                       Converter={StaticResource BoolToVisibilityConverterInverted}}" />
                        </Grid>
                        <Label Height="18"
                               Padding="5 0"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Background="{Binding (sequenceDiagram:Palette.Brush1),
                                                    ElementName=PopupBorder}"
                               Content="{Binding SagaName}"
                               Foreground="{Binding (sequenceDiagram:Palette.Brush2),
                                                    ElementName=PopupBorder}" />
                    </StackPanel>
                </Grid>

                <Grid.Style>
                    <Style>
                        <Setter Property="sequenceDiagram:Palette.Brush1" Value="{StaticResource Grey40Brush}" />
                        <Setter Property="sequenceDiagram:Palette.Brush2" Value="White" />
                        <Setter Property="sequenceDiagram:Palette.Brush3" Value="Transparent" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Selected}" Value="True">
                                <Setter Property="sequenceDiagram:Palette.Brush1" Value="White" />
                                <Setter Property="sequenceDiagram:Palette.Brush2" Value="{StaticResource HiliteDarkBrush}" />
                                <Setter Property="sequenceDiagram:Palette.Brush3" Value="{StaticResource HiliteDarkBrush}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
            </Grid>
        </Border>

        <!--  Vertical arrow for each to endpoint  -->
        <ItemsControl x:Name="SendMessageArrows" ItemsSource="{Binding ToEndpointIndicies}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel Width="{StaticResource ColumnWidth}"
                                Margin="{Binding Converter={StaticResource ToEndpointMarginConverter}}"
                                HorizontalAlignment="Left">
                        <!--  Line  -->
                        <Line HorizontalAlignment="Center"
                              Fill="Black"
                              Stroke="Black"
                              StrokeEndLineCap="Square"
                              StrokeThickness="4"
                              X1="0"
                              X2="0"
                              Y1="0"
                              Y2="25" />
                        <!--  Arrow  -->
                        <Path Width="14"
                              Height="11"
                              HorizontalAlignment="Center"
                              Data="{StaticResource DownArrow}"
                              Fill="Black"
                              Stretch="Fill" />
                        <!--  Grey box  -->
                        <Rectangle Width="14"
                                   Height="36"
                                   HorizontalAlignment="Center"
                                   Fill="{StaticResource Grey60Brush}" />
                    </StackPanel>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</UserControl>